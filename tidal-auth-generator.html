<!DOCTYPE html>
<html lang="de"><meta charset="utf-8">
<title>TIDAL PKCE Auth-URL-Generator (ohne externe Scripts)</title>
<style>
 body{font:16px/1.45 Arial;max-width:600px;margin:40px auto}
 label{display:block;margin:10px 0 4px}
 input{width:100%;padding:6px}
 textarea{width:100%;height:90px;margin-top:8px;font-family:monospace}
 button{margin-top:14px;padding:8px 14px}
</style>

<h1>TIDAL OAuth (Authorization Code + PKCE)</h1>

<label>Client ID
  <input id="cid" placeholder="z. B. 0e97…">
</label>

<label>Redirect URI (Overlay-Pfad)
  <input id="redir" value="https://example.com/tidal-now-playing-overlay.html">
</label>

<label>Scope(s) (Leerzeichen-getrennt)
  <input id="scope" value="collection.read">
</label>

<button id="gen">URL erzeugen & öffnen</button>

<h2>Login-URL</h2>
<textarea id="out" readonly></textarea>

<script>
const b64url = buf =>
  btoa(String.fromCharCode(...new Uint8Array(buf)))
    .replace(/\+/g,'-').replace(/\//g,'_').replace(/=+$/,'');

document.getElementById('gen').onclick = async () => {
  const cid   = cidEl.value.trim();
  const redir = redirEl.value.trim();
  const scope = scopeEl.value.trim() || 'collection.read';
  if(!cid || !redir) return alert('Bitte Client-ID & Redirect-URI angeben!');
  // 1. Code Verifier (zufälliger 32-Byte-String → base64url, 43-128 Zeichen)
  const rand = crypto.getRandomValues(new Uint8Array(32));
  const code_verifier = b64url(rand);
  // 2. Code-Challenge = SHA-256(verifier) → base64url
  const hashBuf = await crypto.subtle.digest('SHA-256',
                    new TextEncoder().encode(code_verifier));
  const code_challenge = b64url(hashBuf);
  // 3. CSRF-State
  const state = crypto.randomUUID();
  // 4. Verifier & Client-ID in sessionStorage sichern (Overlay braucht sie)
  sessionStorage.setItem('tidal_cv',  code_verifier);
  sessionStorage.setItem('tidal_cid', cid);
  // 5. Login-URL zusammensetzen
  const url = new URL('https://login.tidal.com/authorize');
  url.searchParams.set('response_type','code');
  url.searchParams.set('client_id', cid);
  url.searchParams.set('redirect_uri', redir);
  url.searchParams.set('scope', scope);
  url.searchParams.set('state', state);
  url.searchParams.set('code_challenge', code_challenge);
  url.searchParams.set('code_challenge_method','S256');
  // Ausgabe & direkt öffnen
  out.value = url.toString();
  window.open(url, '_blank');
};

// DOM-Abkürzungen
const cidEl   = document.getElementById('cid');
const redirEl = document.getElementById('redir');
const scopeEl = document.getElementById('scope');
const out     = document.getElementById('out');
</script>
</html>
