<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <title>TIDAL Now-Playing Overlay</title>
  <style>
    body      { margin:0; background:#1a1a1a; color:#eee;
                font-family:sans-serif; text-align:center; }
    #song     { font-size:1.6rem; margin-top:1.2rem; }
    #artist   { font-size:1.25rem; color:#bdbdbd; }
    #progress { font-size:1rem;  color:#9a9a9a; }
  </style>
</head>
<body>
  <h1>Jetzt läuft</h1>
  <div id="song">–</div>
  <div id="artist">–</div>
  <div id="progress">–</div>

<script>
(async () => {
  /* ─────────────────────────────────────────────
     1. Essentials aus URL + sessionStorage holen
  ───────────────────────────────────────────────*/
  const qs           = new URLSearchParams(location.search);
  const code         = qs.get('code');                // ?code=...
  const clientId     = sessionStorage.getItem('tidal_cid');
  const codeVerifier = sessionStorage.getItem('tidal_cv');

  const info = (txt) => (document.getElementById('song').innerText = txt);

  if (!clientId || !codeVerifier) {
    info('Generator nicht vorher ausgeführt – keine PKCE-Daten gefunden!');
    console.warn('clientId oder codeVerifier fehlen in sessionStorage');
    return;
  }
  if (!code) {
    info('Kein Auth-Code – starte das Overlay über den Generator-Flow.');
    return;
  }

  /* ─────────────────────────────────────────────
     2. Access- & Refresh-Token holen
  ───────────────────────────────────────────────*/
  const redirectUri = location.origin + location.pathname;

  async function tokenReq(body) {
    const resp = await fetch('https://auth.tidal.com/v1/oauth2/token', {
      method : 'POST',
      headers: { 'Content-Type':'application/x-www-form-urlencoded' },
      body   : new URLSearchParams(body)
    });
    if (!resp.ok) throw new Error(`Token-Fehler ${resp.status}`);
    return resp.json();
  }

  let accessToken, refreshToken, expiresAt;

  try {
    const t = await tokenReq({
      grant_type   : 'authorization_code',
      code,
      code_verifier: codeVerifier,
      redirect_uri : redirectUri,
      client_id    : clientId
    });
    accessToken  = t.access_token;
    refreshToken = t.refresh_token;
    expiresAt    = Date.now() + t.expires_in * 1000;
  } catch (e) {
    console.error(e);
    info('Token-Tausch fehlgeschlagen.');
    return;
  }

  /* ─────────────────────────────────────────────
     3. Helfer: Token refreshen, Track abrufen
  ───────────────────────────────────────────────*/
  async function refreshIfNeeded() {
    if (Date.now() < expiresAt - 60000) return;   // > 60 s übrig
    try {
      const t = await tokenReq({
        grant_type   : 'refresh_token',
        refresh_token: refreshToken,
        client_id    : clientId
      });
      accessToken  = t.access_token;
      if (t.refresh_token) refreshToken = t.refresh_token;
      expiresAt    = Date.now() + t.expires_in * 1000;
    } catch (e) {
      console.error('Refresh-Fehler', e);
    }
  }

  async function updateNowPlaying() {
    await refreshIfNeeded();
    try {
      const r = await fetch(
        'https://api.tidalhifi.com/v1/me/player/currently-playing',
        { headers:{ Authorization:`Bearer ${accessToken}` } }
      );
      if (r.status === 401) { await refreshIfNeeded(); return; }
      if (!r.ok) { console.warn('API-Status', r.status); return; }

      const d = await r.json();
      const title  = d.item?.title  || d.item?.name   || '–';
      const artist = d.item?.artist?.name
                  || d.item?.artists?.[0]?.name       || '–';
      const posMs  = d.progress_ms || d.position      || 0;
      const mm = Math.floor(posMs/60000);
      const ss = String(Math.floor(posMs/1000)%60).padStart(2,'0');

      document.getElementById('song'    ).textContent = title;
      document.getElementById('artist'  ).textContent = artist;
      document.getElementById('progress').textContent = `${mm}:${ss}`;
    } catch (e) { console.error(e); }
  }

  /* ─────────────────────────────────────────────
     4. Start!
  ───────────────────────────────────────────────*/
  updateNowPlaying();
  setInterval(updateNowPlaying, 5000);
})();
</script>
</body>
</html>
