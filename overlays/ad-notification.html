<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AD NOTIFICATION - v.1.0.2 - tawmae.xyz</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;900&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/@streamerbot/client/dist/streamerbot-client.js"></script>
  <style>
    body {
      margin: 0;
      padding: 0;
      font-family: 'Inter', sans-serif;
      background-color: #1b2838;
      color: white;
    }

    #status-indicator {
      position: fixed;
      top: 10px;
      left: 50%;
      transform: translateX(-50%);
      background: red;
      color: #fff;
      padding: 5px 12px;
      border-radius: 6px;
      font-size: 14px;
      z-index: 9999;
      transition: background 0.5s, opacity 0.5s;
    }

    .hidden {
      opacity: 0;
      pointer-events: none;
    }

    .notification-container {
      position: fixed;
      top: 20px;
      width: auto;
      background: linear-gradient(145deg, #2a2a2a, #1e1e1e);
      color: white;
      border-radius: 12px;
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.4);
      display: none;
      align-items: center;
      padding: 15px 20px;
      gap: 15px;
      overflow: hidden;
      zoom: 150%;
    }

    .notification-title {
      font-size: 18px;
      font-weight: 900;
      color: var(--title-color, #ffd700);
      text-transform: uppercase;
      letter-spacing: 1px;
      margin: 0 0 5px 0;
    }

    .subtitle-container {
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .notification-description {
      font-size: 14px;
      font-weight: 600;
      color: #bbb;
      margin: 0;
    }

    .notification-icon {
      width: 16px;
      height: 16px;
      border-radius: 4px;
      flex-shrink: 0;
      object-fit: cover;
    }

    .circle-container {
      position: relative;
      width: 60px;
      height: 60px;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    .countdown-circle {
      position: relative;
      width: 100%;
      height: 100%;
      border-radius: 50%;
      background: conic-gradient(var(--loading-bar-color, #ffd700) var(--progress), #333 var(--progress) 100%);
      display: flex;
      justify-content: center;
      align-items: center;
    }

    .countdown-circle span {
      position: absolute;
      display: flex;
      justify-content: center;
      align-items: center;
      color: var(--loading-bar-color, #ffd700);
      background-color: #222;
      width: 48px;
      height: 48px;
      border-radius: 50%;
      font-size: 20px;
      font-weight: 700;
    }

    @keyframes slideInRight {
      from {
        right: -420px;
        opacity: 0;
      }

      to {
        right: 20px;
        opacity: 1;
      }
    }

    @keyframes slideOutRight {
      from {
        right: 20px;
        opacity: 1;
      }

      to {
        right: -420px;
        opacity: 0;
      }
    }

    @keyframes slideInLeft {
      from {
        left: -420px;
        opacity: 0;
      }

      to {
        left: 20px;
        opacity: 1;
      }
    }

    @keyframes slideOutLeft {
      from {
        left: 20px;
        opacity: 1;
      }

      to {
        left: -420px;
        opacity: 0;
      }
    }
  </style>
</head>

<body>
  <div id="status-indicator">[TAWMAE - AD NOTIFICATION] DISCONNECTED</div>
  <div id="notification" class="notification-container">
    <div class="circle-container">
      <div class="countdown-circle" id="countdown-circle" style="--progress: 100%;">
        <span id="countdown-value">10</span>
      </div>
    </div>
    <div>
      <p class="notification-title" id="notification-title"></p>
      <div class="subtitle-container">
        <p class="notification-description" id="notification-description"></p>
        <img id="notification-icon" class="notification-icon" alt="Icon">
      </div>
    </div>
  </div>

  <script>
    const urlParams = new URLSearchParams(window.location.search);
    const soundEnabled = urlParams.get("sound") === "true";
    const rawColor = urlParams.get("color") || "ffd700";
    const font = urlParams.get("font") || "Inter";
    const address = urlParams.get("address") || "localhost";
    const port = parseInt(urlParams.get("port") || "8080", 10);
    const password = urlParams.get("password") || undefined;
    const reverseEntry = urlParams.get("reverseEntry") === "true";
    const warningsParam = (urlParams.get("warnings") || "1")
      .split(",")
      .map(s => parseInt(s.trim(), 10))
      .filter(n => [1, 2, 3, 4, 5].includes(n));
    const warningsSet = new Set(warningsParam.length ? warningsParam : [1]);

    const notification = document.getElementById("notification");
    notification.style[reverseEntry ? "left" : "right"] = "-420px";

    const audioCache = new Map();
    const notificationQueue = [];
    let isNotificationActive = false;
    let upcomingCounter = 0;
    let lastUpcomingAt = 0;

    const statusIndicator = document.getElementById("status-indicator");

    function log(...args) {
      console.log("[AD OVERLAY]", ...args);
    }

    function normalizeColor(color) {
      const hexPattern = /^[0-9a-f]{6}$/i;
      return hexPattern.test(color) ? `#${color}` : color;
    }

    const color = normalizeColor(rawColor);
    document.documentElement.style.setProperty("--title-color", color);
    document.documentElement.style.setProperty("--loading-bar-color", color);
    document.body.style.fontFamily = font;

    function enqueueNotification(title, description, duration, soundUrl, iconUrl) {
      log(`Enqueued notification: "${title}" (${duration}s)`);
      notificationQueue.push({ title, description, duration, soundUrl, iconUrl });
      if (!isNotificationActive) processQueue();
    }

    function processQueue() {
      if (notificationQueue.length === 0) {
        isNotificationActive = false;
        return;
      }
      isNotificationActive = true;
      const { title, description, duration, soundUrl, iconUrl } = notificationQueue.shift();
      showNotification(title, description, duration, soundUrl, iconUrl).then(processQueue);
    }

    function getAudio(url) {
      if (!audioCache.has(url)) {
        const audio = new Audio(url);
        audioCache.set(url, audio);
      }
      return audioCache.get(url);
    }

    function showNotification(title, description, duration, soundUrl, iconUrl) {
      return new Promise((resolve) => {
        const titleElem = document.getElementById("notification-title");
        const descriptionElem = document.getElementById("notification-description");
        const iconElem = document.getElementById("notification-icon");
        const countdownCircle = document.getElementById("countdown-circle");
        const countdownValue = document.getElementById("countdown-value");

        titleElem.textContent = title;
        descriptionElem.textContent = description;
        countdownValue.textContent = duration;
        iconElem.src = iconUrl || "";
        countdownCircle.style.setProperty("--progress", "100%");
        notification.style.display = "flex";

        const inAnim = reverseEntry ? "slideInLeft" : "slideInRight";
        const outAnim = reverseEntry ? "slideOutLeft" : "slideOutRight";
        notification.style.animation = `${inAnim} 0.6s ease-out forwards`;

        if (soundEnabled && soundUrl) {
          const audio = getAudio(soundUrl);
          audio.currentTime = 0;
          audio.play().catch(() => { });
          log("Playing sound:", soundUrl);
        }

        const startTime = Date.now();
        const endTime = startTime + duration * 1000;

        function updateProgress() {
          const currentTime = Date.now();
          const elapsed = currentTime - startTime;
          const remainingTime = Math.max(0, Math.ceil((endTime - currentTime) / 1000));
          const progress = Math.max(0, 1 - elapsed / (duration * 1000));
          countdownValue.textContent = remainingTime;
          countdownCircle.style.setProperty("--progress", `${progress * 100}%`);
          if (remainingTime > 0) {
            requestAnimationFrame(updateProgress);
          } else {
            countdownValue.textContent = 0;
            countdownCircle.style.setProperty("--progress", `0%`);
            setTimeout(() => {
              notification.style.animation = `${outAnim} 0.6s ease-in forwards`;
              setTimeout(() => {
                notification.style.display = "none";
                resolve();
              }, 600);
            }, 250);
          }
        }

        requestAnimationFrame(updateProgress);
      });
    }

    function deriveMinutesFromSequence() {
      const now = Date.now();
      if (lastUpcomingAt && now - lastUpcomingAt > 10 * 60 * 1000) {
        upcomingCounter = 0;
      }
      upcomingCounter = Math.min(upcomingCounter + 1, 5);
      lastUpcomingAt = now;
      return 6 - upcomingCounter;
    }

    function connectClient() {
      const client = new StreamerbotClient({
        host: address,
        port,
        password,
        logLevel: "verbose",
        onConnect: () => {
          log("Connected to Streamer.bot");
          statusIndicator.textContent = "[TAWMAE - AD NOTIFICATION] CONNECTED";
          statusIndicator.style.background = "green";
          setTimeout(() => statusIndicator.classList.add("hidden"), 2000);
        },
        onDisconnect: () => {
          log("Disconnected from Streamer.bot");
          statusIndicator.textContent = "[TAWMAE - AD NOTIFICATION] DISCONNECTED";
          statusIndicator.style.background = "red";
          statusIndicator.classList.remove("hidden");
        },
        onError: (err) => {
          log("Error:", err);
          statusIndicator.textContent = "[TAWMAE - AD NOTIFICATION] ERROR";
          statusIndicator.style.background = "orange";
          statusIndicator.classList.remove("hidden");
        },
        reconnect: true,
        reconnectInterval: 5000
      });

      client.on("Twitch.UpcomingAd", (evt) => {
        const data = evt?.data || {};
        let minutes = typeof data.minutes === "number" ? data.minutes : deriveMinutesFromSequence();
        minutes = Math.min(Math.max(minutes, 1), 5);
        upcomingCounter = 5 - minutes + 1;
        lastUpcomingAt = Date.now();
        log(`Received UpcomingAd (#${upcomingCounter}) => ${minutes} minute(s)`);
        if (warningsSet.has(minutes)) {
          const text = `Ads start in about ${minutes} ${minutes === 1 ? "minute" : "minutes"}`;
          enqueueNotification(
            "Upcoming Ads",
            text,
            10,
            null,
            "https://raw.githubusercontent.com/tawmae/tawmae.github.io/refs/heads/main/overlays/ads_2.webp"
          );
        } else {
          log(`Skipped UpcomingAd for ${minutes} minute(s)`);
        }
      });

      client.on("Twitch.AdRun", (evt) => {
        const data = evt?.data || {};
        const len =
          (typeof data.length_seconds === "number" && data.length_seconds) ||
          (typeof data.adLength === "number" && data.adLength) ||
          (typeof data.adLengthMs === "number" && Math.round(data.adLengthMs / 1000)) ||
          30;
        upcomingCounter = 0;
        lastUpcomingAt = 0;
        log("Received AdRun event");
        enqueueNotification(
          "Ads Running",
          "Ads are currently in progress",
          len,
          "https://tawmae.github.io/overlays/ads_1.mp3",
          "https://raw.githubusercontent.com/tawmae/tawmae.github.io/refs/heads/main/overlays/ads_2.webp"
        );
      });
    }

    window.addEventListener("load", connectClient);
  </script>
</body>

</html>
